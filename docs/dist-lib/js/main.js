!function(n,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["wasm-png-compress"]=t():n["wasm-png-compress"]=t()}(this,(function(){return function(n){var t={};function e(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return n[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=n,e.c=t,e.d=function(n,t,r){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:r})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(r,i,function(t){return n[t]}.bind(null,i));return r},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=1)}([function(n,t,e){"use strict";e.r(t),t.default="../wasm/image_compressor.2c041dfa2867dc4a73f920da36591a05.wasm"},function(n,t,e){"use strict";e.r(t),e.d(t,"processFile",(function(){return c})),e.d(t,"downloadImage",(function(){return s}));const r=new Worker(e(2));r.onmessage=n=>{switch(n.data.type){case"log":a(n.data.msg);break;case"logError":u(n.data.msg);break;case"result":f(t=n.data.result,"img-result"),o.inProgress=!1,o.result=t,a(o);break;case"error":u(n.data.error),o.inProgress=!1}var t};let i,o={};function a(n){let t=Math.round(performance.now()-i).toString();for(;t.length<5;)t=" "+t;console.log(`[${t}ms] ${n}\n`)}function u(n){a("ERROR "+n)}const l={maxColors:256,dithering:.5};function c(n,t=l){if(o={fileName:n.name},"image/png"!=n.type)return void a("invalid image type");a("Loading file data");const e=new FileReader;e.onload=e=>{const i=e.target.result;a(`File data loaded: ${n.name}, ${i.byteLength} bytes`),function(n,t){const e=n.byteLength;f(n,"img-original").then(n=>{const i=n.origWidth,u=n.origHeight;a(`Image decoded: ${i}x${u}`);const l=document.createElement("canvas");l.width=i,l.height=u;const c=l.getContext("2d");c.drawImage(n,0,0);const s=c.getImageData(0,0,i,u).data;a(`Converted to RGB data: ${s.byteLength} bytes`),o.width=i,o.height=u,o.rgbData=s,o.fileSize=e,o.options=t,o.inProgress=!0,r.postMessage({type:"image",rgbData:o.rgbData,width:o.width,height:o.height,fileSize:o.fileSize,options:o.options})}).catch(n=>{u(n)})}(i,t)},e.onerror=()=>{a("fail to load")},e.readAsArrayBuffer(n)}function s(){const n=new Blob([o.result],{type:"image/png"}),t=URL.createObjectURL(n),e=document.createElement("a");e.href=t,e.download=o.fileName.replace(".png",".min.png"),e.style="display: none",document.body.appendChild(e),e.click(),e.remove(),setTimeout(()=>{URL.revokeObjectURL(t)},1e3)}function f(n,t){return new Promise((e,r)=>{const i=new Uint8Array(n),o=new Blob([i],{type:"image/png"}),a=URL.createObjectURL(o),u=document.createElement("img");u.style.display="none",u.src=a,u.className=t,u.onload=n=>{u.origWidth=u.width,u.origHeight=u.height,u.style.display="block",URL.revokeObjectURL(a),e(u)},u.onerror=n=>{r("Error loading image, maybe it's not in PNG format?")}})}},function(n,t,e){(function(n){self.Module={wasmBinaryFile:e(0),print:bn,printErr:wn};var t,r=void 0!==r?r:{},i={};for(t in r)r.hasOwnProperty(t)&&(i[t]=r[t]);var o,a,u,l=[];o="object"==typeof window,a="function"==typeof importScripts,u="object"==typeof n&&"object"==typeof n.versions&&"string"==typeof n.versions.node;var c,s="";(o||a)&&(a?s=self.location.href:document.currentScript&&(s=document.currentScript.src),s=0!==s.indexOf("blob:")?s.substr(0,s.lastIndexOf("/")+1):"",function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.send(null),t.responseText},a&&(c=function(n){var t=new XMLHttpRequest;return t.open("GET",n,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),function(n,t,e){var r=new XMLHttpRequest;r.open("GET",n,!0),r.responseType="arraybuffer",r.onload=function(){200==r.status||0==r.status&&r.response?t(r.response):e()},r.onerror=e,r.send(null)});var f=r.print||console.log.bind(console),p=r.printErr||console.warn.bind(console);for(t in i)i.hasOwnProperty(t)&&(r[t]=i[t]);i=null,r.arguments&&(l=r.arguments),r.thisProgram&&r.thisProgram,r.quit&&r.quit;var d,m,y=0,h=function(n){y=n};r.wasmBinary&&(d=r.wasmBinary),r.noExitRuntime&&r.noExitRuntime,"object"!=typeof WebAssembly&&p("no native wasm support detected");var g=new WebAssembly.Table({initial:57,maximum:57,element:"anyfunc"}),v=!1;function b(n){var t,e=r["_"+n];return t="Cannot call unknown function "+n+", make sure it is exported",e||F("Assertion failed: "+t),e}function w(n,t,e,r,i){var o={string:function(n){var t=0;if(null!=n&&0!==n){var e=1+(n.length<<2);(function(n,t,e){(function(n,t,e,r){if(!(r>0))return 0;for(var i=e,o=e+r-1,a=0;a<n.length;++a){var u=n.charCodeAt(a);if(u>=55296&&u<=57343){var l=n.charCodeAt(++a);u=65536+((1023&u)<<10)|1023&l}if(u<=127){if(e>=o)break;t[e++]=u}else if(u<=2047){if(e+1>=o)break;t[e++]=192|u>>6,t[e++]=128|63&u}else if(u<=65535){if(e+2>=o)break;t[e++]=224|u>>12,t[e++]=128|u>>6&63,t[e++]=128|63&u}else{if(e+3>=o)break;t[e++]=240|u>>18,t[e++]=128|u>>12&63,t[e++]=128|u>>6&63,t[e++]=128|63&u}}t[e]=0})(n,j,t,e)})(n,t=hn(e),e)}return t},array:function(n){var t=hn(n.length);return function(n,t){T.set(n,t)}(n,t),t}};var a=b(n),u=[],l=0;if(r)for(var c=0;c<r.length;c++){var s=o[e[c]];s?(0===l&&(l=yn()),u[c]=s(r[c])):u[c]=r[c]}var f=a.apply(null,u);return f=function(n){return"string"===t?A(n):"boolean"===t?Boolean(n):n}(f),0!==l&&gn(l),f}var _="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function C(n,t,e){for(var r=t+e,i=t;n[i]&&!(i>=r);)++i;if(i-t>16&&n.subarray&&_)return _.decode(n.subarray(t,i));for(var o="";t<i;){var a=n[t++];if(128&a){var u=63&n[t++];if(192!=(224&a)){var l=63&n[t++];if((a=224==(240&a)?(15&a)<<12|u<<6|l:(7&a)<<18|u<<12|l<<6|63&n[t++])<65536)o+=String.fromCharCode(a);else{var c=a-65536;o+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else o+=String.fromCharCode((31&a)<<6|u)}else o+=String.fromCharCode(a)}return o}function A(n,t){return n?C(j,n,t):""}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var R,T,j,x,E,S,k;function L(n){R=n,r.HEAP8=T=new Int8Array(n),r.HEAP16=x=new Int16Array(n),r.HEAP32=E=new Int32Array(n),r.HEAPU8=j=new Uint8Array(n),r.HEAPU16=new Uint16Array(n),r.HEAPU32=new Uint32Array(n),r.HEAPF32=S=new Float32Array(n),r.HEAPF64=k=new Float64Array(n)}var P=r.INITIAL_MEMORY||16777216;function M(n){for(;n.length>0;){var t=n.shift();if("function"!=typeof t){var e=t.func;"number"==typeof e?void 0===t.arg?r.dynCall_v(e):r.dynCall_vi(e,t.arg):e(void 0===t.arg?null:t.arg)}else t()}}(m=r.wasmMemory?r.wasmMemory:new WebAssembly.Memory({initial:P/65536}))&&(R=m.buffer),P=R.byteLength,L(R),E[4780]=5262160;var I=[],O=[],U=[],W=[];var H=0,D=null,B=null;function F(n){throw r.onAbort&&r.onAbort(n),f(n+=""),p(n),v=!0,1,n="abort("+n+"). Build with -s ASSERTIONS=1 for more info.",new WebAssembly.RuntimeError(n)}r.preloadedImages={},r.preloadedAudios={};function $(n){return String.prototype.startsWith?n.startsWith("data:application/octet-stream;base64,"):0===n.indexOf("data:application/octet-stream;base64,")}var z,N=e(0);function q(){try{if(d)return new Uint8Array(d);if(c)return c(N);throw"both async and sync fetching of the wasm failed"}catch(n){F(n)}}$(N)||(z=N,N=r.locateFile?r.locateFile(z,s):s+z),O.push({func:function(){Y()}});var G=0;function V(n){try{return m.grow(n-R.byteLength+65535>>16),L(m.buffer),1}catch(n){}}var X={mappings:{},buffers:[null,[],[]],printChar:function(n,t){var e=X.buffers[n];0===t||10===t?((1===n?f:p)(C(e,0)),e.length=0):e.push(t)},varargs:void 0,get:function(){return X.varargs+=4,E[X.varargs-4>>2]},getStr:function(n){return A(n)},get64:function(n,t){return n}};var J={m:function(){F()},e:function(n,t){!function(n,t){throw Z(n,t||1),"longjmp"}(n,t)},r:function(n,t,e){j.copyWithin(n,t,t+e)},s:function(n){var t=j.length;if(n>2147418112)return!1;for(var e,r,i=1;i<=4;i*=2){var o=t*(1+.2/i);if(o=Math.min(o,n+100663296),V(Math.min(2147418112,((e=Math.max(16777216,n,o))%(r=65536)>0&&(e+=r-e%r),e))))return!0}return!1},t:function(n){return 0},q:function(n,t,e,r,i){},l:function(n,t,e,r){for(var i=0,o=0;o<e;o++){for(var a=E[t+8*o>>2],u=E[t+(8*o+4)>>2],l=0;l<u;l++)X.printChar(n,j[a+l]);i+=u}return E[r>>2]=i,0},a:function(){return 0|y},x:function(n){var t=yn();try{return ln(n)}catch(n){if(gn(t),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},j:function(n,t){var e=yn();try{return cn(n,t)}catch(n){if(gn(e),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},o:function(n,t,e){var r=yn();try{return mn(n,t,e)}catch(n){if(gn(r),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},g:function(n,t,e){var r=yn();try{return sn(n,t,e)}catch(n){if(gn(r),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},k:function(n,t,e,r){var i=yn();try{return fn(n,t,e,r)}catch(n){if(gn(i),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},d:function(n,t,e,r,i){var o=yn();try{return pn(n,t,e,r,i)}catch(n){if(gn(o),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},p:function(n,t,e,r,i,o){var a=yn();try{return dn(n,t,e,r,i,o)}catch(n){if(gn(a),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},h:function(n,t){var e=yn();try{tn(n,t)}catch(n){if(gn(e),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},f:function(n,t,e){var r=yn();try{en(n,t,e)}catch(n){if(gn(r),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},v:function(n,t,e,r){var i=yn();try{rn(n,t,e,r)}catch(n){if(gn(i),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},i:function(n,t,e,r,i){var o=yn();try{on(n,t,e,r,i)}catch(n){if(gn(o),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},u:function(n,t,e,r,i,o){var a=yn();try{an(n,t,e,r,i,o)}catch(n){if(gn(a),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},w:function(n,t,e,r,i,o,a,u,l,c){var s=yn();try{un(n,t,e,r,i,o,a,u,l,c)}catch(n){if(gn(s),n!==n+0&&"longjmp"!==n)throw n;Z(1,0)}},memory:m,n:function n(t,e,r,i){e|=0,r|=0,i|=0;var o=0;for(G=G+1|0,E[(t|=0)>>2]=G;(0|o)<(0|i);){if(0==(0|E[r+(o<<3)>>2]))return E[r+(o<<3)>>2]=G,E[r+(4+(o<<3))>>2]=e,E[r+(8+(o<<3))>>2]=0,h(0|i),0|r;o=o+1|0}return r=0|n(0|t,0|e,0|(r=0|nn(0|r,8*((i=2*i|0)+1|0)|0)),0|i),h(0|i),0|r},b:function(n){h(0|n)},table:g,c:function(n,t,e){n|=0,t|=0,e|=0;for(var r=0,i=0;(0|r)<(0|e)&&0!=(0|(i=0|E[t+(r<<3)>>2]));){if((0|i)==(0|n))return 0|E[t+(4+(r<<3))>>2];r=r+1|0}return 0}},K=function(){var n={a:J};function t(n,t){var e=n.exports;r.asm=e,function(n){if(H--,r.monitorRunDependencies&&r.monitorRunDependencies(H),0==H&&(null!==D&&(clearInterval(D),D=null),B)){var t=B;B=null,t()}}()}function e(n){t(n.instance)}function i(t){return(d||!o&&!a||"function"!=typeof fetch?new Promise((function(n,t){n(q())})):fetch(N,{credentials:"same-origin"}).then((function(n){if(!n.ok)throw"failed to load wasm binary file at '"+N+"'";return n.arrayBuffer()})).catch((function(){return q()}))).then((function(t){return WebAssembly.instantiate(t,n)})).then(t,(function(n){p("failed to asynchronously prepare wasm: "+n),F(n)}))}if(H++,r.monitorRunDependencies&&r.monitorRunDependencies(H),r.instantiateWasm)try{return r.instantiateWasm(n,t)}catch(n){return p("Module.instantiateWasm callback failed with error: "+n),!1}return function(){if(d||"function"!=typeof WebAssembly.instantiateStreaming||$(N)||"function"!=typeof fetch)return i(e);fetch(N,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,n).then(e,(function(n){p("wasm streaming compile failed: "+n),p("falling back to ArrayBuffer instantiation"),i(e)}))}))}(),{}}();r.asm=K;var Q,Y=r.___wasm_call_ctors=function(){return(Y=r.___wasm_call_ctors=r.asm.y).apply(null,arguments)},Z=(r._compress=function(){return(r._compress=r.asm.z).apply(null,arguments)},r._malloc=function(){return(r._malloc=r.asm.A).apply(null,arguments)},r._free=function(){return(r._free=r.asm.B).apply(null,arguments)},r._setThrew=function(){return(Z=r._setThrew=r.asm.C).apply(null,arguments)}),nn=r._realloc=function(){return(nn=r._realloc=r.asm.D).apply(null,arguments)},tn=r.dynCall_vi=function(){return(tn=r.dynCall_vi=r.asm.E).apply(null,arguments)},en=r.dynCall_vii=function(){return(en=r.dynCall_vii=r.asm.F).apply(null,arguments)},rn=r.dynCall_viii=function(){return(rn=r.dynCall_viii=r.asm.G).apply(null,arguments)},on=r.dynCall_viiii=function(){return(on=r.dynCall_viiii=r.asm.H).apply(null,arguments)},an=r.dynCall_viiiii=function(){return(an=r.dynCall_viiiii=r.asm.I).apply(null,arguments)},un=r.dynCall_viiiiiiiii=function(){return(un=r.dynCall_viiiiiiiii=r.asm.J).apply(null,arguments)},ln=r.dynCall_i=function(){return(ln=r.dynCall_i=r.asm.K).apply(null,arguments)},cn=r.dynCall_ii=function(){return(cn=r.dynCall_ii=r.asm.L).apply(null,arguments)},sn=r.dynCall_iii=function(){return(sn=r.dynCall_iii=r.asm.M).apply(null,arguments)},fn=r.dynCall_iiii=function(){return(fn=r.dynCall_iiii=r.asm.N).apply(null,arguments)},pn=r.dynCall_iiiii=function(){return(pn=r.dynCall_iiiii=r.asm.O).apply(null,arguments)},dn=r.dynCall_iiiiid=function(){return(dn=r.dynCall_iiiiid=r.asm.P).apply(null,arguments)},mn=r.dynCall_iif=function(){return(mn=r.dynCall_iif=r.asm.Q).apply(null,arguments)},yn=r.stackSave=function(){return(yn=r.stackSave=r.asm.R).apply(null,arguments)},hn=r.stackAlloc=function(){return(hn=r.stackAlloc=r.asm.S).apply(null,arguments)},gn=r.stackRestore=function(){return(gn=r.stackRestore=r.asm.T).apply(null,arguments)};function vn(n){function t(){Q||(Q=!0,r.calledRun=!0,v||(!0,M(O),M(U),r.onRuntimeInitialized&&r.onRuntimeInitialized(),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)n=r.postRun.shift(),W.unshift(n);var n;M(W)}()))}n=n||l,H>0||(!function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)n=r.preRun.shift(),I.unshift(n);var n;M(I)}(),H>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("")}),1),t()}),1)):t()))}if(r.asm=K,r.ccall=w,r.cwrap=function(n,t,e,r){var i=(e=e||[]).every((function(n){return"number"===n}));return"string"!==t&&i&&!r?b(n):function(){return w(n,t,e,arguments)}},r.getValue=function(n,t,e){switch("*"===(t=t||"i8").charAt(t.length-1)&&(t="i32"),t){case"i1":case"i8":return T[n>>0];case"i16":return x[n>>1];case"i32":case"i64":return E[n>>2];case"float":return S[n>>2];case"double":return k[n>>3];default:F("invalid type for getValue: "+t)}return null},B=function n(){Q||vn(),Q||(B=n)},r.run=vn,r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();function bn(n){self.postMessage({type:"log",msg:n})}function wn(n){self.postMessage({type:"logError",msg:n})}vn(),self.onmessage=n=>{switch(n.data.type){case"image":!function(n){const{rgbData:t,width:e,height:i,fileSize:o,options:a}=n;try{bn("Working...");const n=r._malloc(t.byteLength);if(r.HEAPU8.set(t,n),t.byteLength!==e*i*4)return void self.postMessage({type:"error",error:`Invalid data length: ${t.byteLength}, expected ${e*i*4}`});const u=r._malloc(4),{maxColors:l,dithering:c}=a,s=r._compress(e,i,l,c,n,u);if(s)self.postMessage({type:"error",error:"Compression error: "+s});else{const t=r.getValue(u,"i32",!1),e=(t/o*100).toFixed(1);bn(`Compressed: ${o} -> ${t} bytes (${e}%)`);const i=new Uint8Array(t);i.set(r.HEAPU8.subarray(n,n+t)),self.postMessage({type:"result",result:i})}r._free(n),r._free(u)}catch(n){wn(n.toString())}}(n.data)}}}).call(this,e(3))},function(n,t){var e,r,i=n.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(n){if(e===setTimeout)return setTimeout(n,0);if((e===o||!e)&&setTimeout)return e=setTimeout,setTimeout(n,0);try{return e(n,0)}catch(t){try{return e.call(null,n,0)}catch(t){return e.call(this,n,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:o}catch(n){e=o}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(n){r=a}}();var l,c=[],s=!1,f=-1;function p(){s&&l&&(s=!1,l.length?c=l.concat(c):f=-1,c.length&&d())}function d(){if(!s){var n=u(p);s=!0;for(var t=c.length;t;){for(l=c,c=[];++f<t;)l&&l[f].run();f=-1,t=c.length}l=null,s=!1,function(n){if(r===clearTimeout)return clearTimeout(n);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(n);try{r(n)}catch(t){try{return r.call(null,n)}catch(t){return r.call(this,n)}}}(n)}}function m(n,t){this.fun=n,this.array=t}function y(){}i.nextTick=function(n){var t=new Array(arguments.length-1);if(arguments.length>1)for(var e=1;e<arguments.length;e++)t[e-1]=arguments[e];c.push(new m(n,t)),1!==c.length||s||u(d)},m.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(n){return[]},i.binding=function(n){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(n){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}}])}));